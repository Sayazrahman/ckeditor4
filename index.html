<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="https://do3n1uzkew47z.cloudfront.net/siteassets/LOGIN/assets/loginPageV2/js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="ckeditor.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/literallycanvas/0.6.1/css/literallycanvas.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/literallycanvas/0.6.1/js/literallycanvas.js"></script>
    <link rel="stylesheet" href="contents.css" />
  </head>

  <body>
    Question :
    <div
      id="introduction"
      contenteditable="true"
      style="border: 1px solid"
    ></div>
    op1 :
    <div id="op1" contenteditable="true" style="border: 1px solid"></div>

    <button type="button" onclick="getEditorContent();">
      Get Editor Content
    </button>
    <button id="toggle">Start editing</button>
    <button id="reset" style="display: none">Reset content</button>

    <div id="mathDialogOverlay" class="math-dialog-overlay">
      <iframe id="mathEditorFrame" class="math-dialog-frame" src=""></iframe>
    </div>

    <script>
      var qtext = CKEDITOR.inline(document.getElementById("introduction"));
      var option1 = CKEDITOR.inline(document.getElementById("op1"));

      let activeDiv = null;
      let editingImage = null;

      document
        .getElementById("introduction")
        .addEventListener("focus", function () {
          activeDiv = this;
        });

      document.getElementById("op1").addEventListener("focus", function () {
        activeDiv = this;
      });

      CKEDITOR.plugins.add("mathformula", {
        init: function (editor) {
          editor.ui.addButton("MathFormula", {
            label: "Math Formula",
            command: "insertMath",
            toolbar: "insert",
            icon: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiI+PHRleHQgeD0iNCIgeT0iMTMiIGZvbnQtc2l6ZT0iMTQiPuKOkTwvdGV4dD48L3N2Zz4=",
          });

          editor.addCommand("insertMath", {
            exec: function (editor) {
              if (editor.element.$.id === "introduction") {
                activeDiv = document.getElementById("introduction");
              } else if (editor.element.$.id === "op1") {
                activeDiv = document.getElementById("op1");
              }

              editingImage = null;

              // Store the current selection/range from CKEditor
              const selection = editor.getSelection();
              if (selection) {
                const ranges = selection.getRanges();
                if (ranges && ranges.length > 0) {
                  window.savedRange = ranges[0];
                  window.savedEditor = editor;
                }
              }

              document.getElementById("mathDialogOverlay").style.display =
                "flex";

              const iframe = document.getElementById("mathEditorFrame");
              iframe.src = "plugins/imatheq/common/math-editor.html";
            },
          });

          editor.on("doubleclick", function (evt) {
            const el = evt.data.element;
            if (
              el &&
              el.$ &&
              el.$.classList &&
              el.$.classList.contains("math-formula-img")
            ) {
              if (editor.element.$.id === "introduction") {
                activeDiv = document.getElementById("introduction");
              } else if (editor.element.$.id === "op1") {
                activeDiv = document.getElementById("op1");
              }

              editingImage = el.$;
              document.getElementById("mathDialogOverlay").style.display =
                "flex";
              const iframe = document.getElementById("mathEditorFrame");
              iframe.src = "plugins/imatheq/common/math-editor.html";

              iframe.onload = function () {
                const latex = el.$.getAttribute("data-imath-latex") || "";
                setTimeout(() => {
                  if (iframe.contentWindow.setInitialLatex) {
                    iframe.contentWindow.setInitialLatex(latex);
                  }
                }, 500);
              };
              evt.data.dialog = null;
            }
          });
        },
      });

      qtext.config.extraPlugins = "mathformula";
      option1.config.extraPlugins = "mathformula";

      window.receiveFormulaFromMathEditor = function (
        latex,
        imgSrc,
        encodedMathML
      ) {
        if (!latex || !imgSrc) {
          alert("Error: Missing data from math editor");
          return;
        }

        if (!activeDiv) {
          alert("Error: Please click inside Question or op1 field first!");
          return;
        }

        try {
          const img = document.createElement("img");
          img.className = "math-formula-img";
          img.src = imgSrc;
          img.setAttribute("data-imath-latex", latex);
          img.setAttribute("imatheq-mml", encodedMathML);
          img.setAttribute("contenteditable", "false");
          img.style.verticalAlign = "middle";
          img.style.maxHeight = "3.5em";
          img.style.height = "auto";
          img.style.maxWidth = "100px";
          img.style.minWidth = "100px";
          img.style.width = "auto";
          img.style.border = "none";
          img.style.padding = "2px";
          img.style.margin = "0 2px";
          img.style.cursor = "pointer";
          img.style.display = "inline-block";

          if (editingImage) {
            editingImage.parentNode.replaceChild(img, editingImage);
          } else if (window.savedRange && window.savedEditor) {
            const editor = window.savedEditor;
            const range = window.savedRange;

            range.deleteContents();

            const imgElement = new CKEDITOR.dom.element(img);
            range.insertNode(imgElement);

            const space = editor.document.createText("\u00A0");
            imgElement.insertAfter(space);

            range.moveToPosition(space, CKEDITOR.POSITION_AFTER_END);
            range.select();

            window.savedRange = null;
            window.savedEditor = null;
          } else {
            const selection = window.getSelection();
            if (
              selection.rangeCount > 0 &&
              activeDiv.contains(selection.anchorNode)
            ) {
              const range = selection.getRangeAt(0);
              range.deleteContents();
              range.insertNode(img);

              const space = document.createTextNode("\u00A0");
              range.collapse(false);
              range.insertNode(space);

              range.setStartAfter(space);
              range.collapse(true);
              selection.removeAllRanges();
              selection.addRange(range);
            } else {
              activeDiv.appendChild(img);
              activeDiv.appendChild(document.createTextNode("\u00A0"));
            }
          }

          document.getElementById("mathDialogOverlay").style.display = "none";
          document.getElementById("mathEditorFrame").src = "";

          if (activeDiv.id === "introduction") {
            qtext.updateElement();
          } else if (activeDiv.id === "op1") {
            option1.updateElement();
          }
        } catch (error) {
          alert("Error inserting formula: " + error.message);
        }
      };

      document.addEventListener(
        "click",
        function (e) {
          const mathImg = e.target.closest(".math-formula-img");
          if (mathImg && mathImg.classList.contains("math-formula-img")) {
            e.preventDefault();
            e.stopPropagation();

            activeDiv =
              mathImg.closest("#introduction") || mathImg.closest("#op1");
            editingImage = mathImg;

            document.getElementById("mathDialogOverlay").style.display = "flex";
            const iframe = document.getElementById("mathEditorFrame");
            iframe.src = "plugins/imatheq/common/math-editor.html";

            iframe.onload = function () {
              const latex = mathImg.getAttribute("data-imath-latex") || "";
              setTimeout(() => {
                if (iframe.contentWindow.setInitialLatex) {
                  iframe.contentWindow.setInitialLatex(latex);
                }
              }, 500);
            };

            iframe.onerror = function () {
              alert(
                "Error: Cannot load math editor. Check that the path plugins/imatheq/common/math-editor.html is correct"
              );
              document.getElementById("mathDialogOverlay").style.display =
                "none";
            };
          }
        },
        true
      );

      window.closeMathDialog = function () {
        document.getElementById("mathDialogOverlay").style.display = "none";
        document.getElementById("mathEditorFrame").src = "";
      };

      document
        .getElementById("mathDialogOverlay")
        .addEventListener("click", function (e) {
          if (e.target === this) window.closeMathDialog();
        });

      function getEditorContent() {
        var qtextContent = document.getElementById("introduction").innerHTML;
        var op1Content = document.getElementById("op1").innerHTML;
        console.log("Question:", qtextContent);
        console.log("Option 1:", op1Content);
      }
    </script>
  </body>
</html>
