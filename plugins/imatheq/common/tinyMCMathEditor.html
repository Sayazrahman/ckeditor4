<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vanilla JS Math Editor with TinyMCE + MathLive + MathJax</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- TinyMCE -->
<script src="https://cdn.tiny.cloud/1/8qkmah7lyvkkkyc86nvy77ls15u9vdo332a10h4qclqebhfn/tinymce/6/tinymce.min.js"
referrerpolicy="origin"></script>

<!-- MathLive -->
<script src="https://cdn.jsdelivr.net/npm/mathlive/dist/mathlive.min.js"></script>

<!-- MathJax -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [["\\(", "\\)"], ["$", "$"]],
    displayMath: [["\\[", "\\]"], ["$$", "$$"]],
    packages: ["base", "ams", "noerrors", "noundefined", "autoload"],
  },
  svg: { fontCache: "global" },
  startup: {
    ready: () => {
      console.log("MathJax ready");
      MathJax.startup.defaultReady();
    }
  }
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg-full.js" async></script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f8f9fa;
  }

  .math-formula-img {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px;
    cursor: pointer;
    vertical-align: middle;
    display: inline-block;
    max-height: 50px;
    transition: border-color .2s;
  }
  .math-formula-img:hover {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0,123,255,0.3);
  }
</style>
</head>

<body>

<h1>Math Editor – Pure Vanilla JS</h1>
<p>Click the ∑ icon to insert mathematical formulas.</p>

<textarea id="editor"></textarea>

<script>
/* ============================
   PART 2 — LATEX → MATHML / PNG
   ============================ */

/** Convert LaTeX → MathML */
function latexToMathML(latex) {
  try {
    if (window.MathJax && MathJax.tex2mml) {
      return MathJax.tex2mml(latex);
    }
  } catch (e) {
    console.warn("MathML conversion failed", e);
  }
  return `<math><mtext>${latex}</mtext></math>`;
}

/** Create fallback PNG if MathJax not ready */
function createFallbackImage(latex, canvas, ctx) {
  const text = latex.length > 20 ? latex.substring(0,20)+"..." : latex;

  ctx.font = "16px serif";
  const w = ctx.measureText(text).width;

  canvas.width = w + 20;
  canvas.height = 40;

  ctx.fillStyle = "#f8f9fa";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#ccc";
  ctx.strokeRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#333";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(text, canvas.width/2, canvas.height/2);

  return canvas.toDataURL("image/png");
}

/** Convert LaTeX → PNG */
async function latexToPNG(latex) {
  return new Promise(async (resolve) => {
    if (!window.MathJax || !MathJax.tex2svg) {
      console.log("MathJax not ready, fallback PNG");
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      return resolve(createFallbackImage(latex, canvas, ctx));
    }

    await new Promise(r => setTimeout(r, 100));

    const svg = MathJax.tex2svg(latex);
    const svgString = MathJax.startup.adaptor.outerHTML(svg);

    const img = new Image();
    const svgBlob = new Blob([svgString], { type: "image/svg+xml" });
    const url = URL.createObjectURL(svgBlob);

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = img.width * 2;
      canvas.height = img.height * 2;
      ctx.scale(2,2);

      ctx.fillStyle = "white";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.drawImage(img, 0,0);

      resolve(canvas.toDataURL("image/png"));
      URL.revokeObjectURL(url);
    };
    img.src = url;
  });
}

/****************************************************
 * PART 3 — TinyMCE Initialization + Math Dialog
 ****************************************************/

function createMathDialog(initialLatex = "", existingImg = null) {
  return {
    title: existingImg ? "Edit Mathematical Formula" : "Insert Mathematical Formula",
    body: {
      type: "panel",
      items: [
        {
          type: "htmlpanel",
          html: `
            <div id="math-dialog-container" style="font-family: Arial;">

              <!-- Toolbar -->
              <div id="math-toolbar" style="background:#f0f0f0;border:1px solid #ccc;padding:6px;margin-bottom:10px;border-radius:4px;display:flex;flex-wrap:wrap;gap:2px;">
                ${generateToolbarButtons()}
              </div>

              <!-- MathLive Input Field -->
              <math-field
                id="mathlive-editor"
                style="
                  width:100%;
                  min-height:120px;
                  font-size:18px;
                  border:2px solid #ddd;
                  border-radius:6px;
                  padding:12px;
                  background:white;
                "
                virtual-keyboard-mode="manual"
                smart-fence="true"
                keypress-sound="none"
                use-shared-virtual-keyboard="true"
              ></math-field>

              <!-- LaTeX Preview -->
              <div style="margin-top:16px;padding:8px;background:#f8f9fa;border:1px solid #e9ecef;border-radius:4px;">
                <b style="font-size:12px;color:#555;">LaTeX Preview:</b>
                <pre id="latex-preview" style="font-size:12px;margin-top:4px;color:#222;">(empty)</pre>
              </div>

              <!-- Export Buttons -->
              <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:8px;">
                <button type="button" class="export-btn" data-type="mathml" style="padding:8px;border:1px solid #007bff;color:#007bff;background:white;border-radius:4px;font-size:12px;">MathML</button>
                <button type="button" class="export-btn" data-type="svg" style="padding:8px;border:1px solid #28a745;color:#28a745;background:white;border-radius:4px;font-size:12px;">SVG</button>
                <button type="button" class="export-btn" data-type="png" style="padding:8px;border:1px solid #ffc107;color:#856404;background:white;border-radius:4px;font-size:12px;">Image (PNG)</button>
                <button type="button" id="math-clear" style="padding:8px;border:1px solid #dc3545;color:#dc3545;background:white;border-radius:4px;font-size:12px;">Clear</button>
              </div>

            </div>
          `,
        }
      ]
    },
    buttons: [
      { type: "cancel", text: "Cancel" },
      { type: "submit", text: "Save", primary: true },
    ],

    onSubmit: async (api) => {
      const field = document.getElementById("mathlive-editor");
      const latex = field.getValue("latex");

      if (!latex.trim()) return api.close();

      api.block("Generating formula...");

      const mathML = latexToMathML(latex);
      const encoded = encodeURIComponent(mathML);

      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="auto" height="auto">
        <foreignObject width="100%" height="100%">
          ${mathML}
        </foreignObject>
      </svg>`;

      const imgSrc = "data:image/svg+xml," + encodeURIComponent(svg);

      const html = `
        <img class="math-formula-img"
             src="${imgSrc}"
             data-imath-latex="${latex.replace(/"/g,"&quot;")}"
             imatheq-mml="${encoded}"
             contenteditable="false"
             style="max-height:2.2em;vertical-align:middle;">
      `;

      if (existingImg) {
        existingImg.outerHTML = html;
      } else {
        tinymce.activeEditor.insertContent(html + "&nbsp;");
      }

      api.unblock();
      api.close();
    },

    onCancel: () => {}
  };
}

/** Generate the toolbar buttons for the dialog dynamically */
function generateToolbarButtons() {
  const buttons = [
    ["\\frac{#@}{#?}", "a/b"],
    ["^{#?}", "x²"],
    ["_{#?}", "x₁"],
    ["\\sqrt{#?}", "√"],
    ["\\sqrt[#@]{#?}", "ⁿ√"],
    ["\\int_{#@}^{#?}", "∫"],
    ["\\sum_{#@}^{#?}", "Σ"],
    ["\\prod_{#@}^{#?}", "∏"],
    ["\\lim_{#?}", "lim"],
    ["\\sin", "sin"],
    ["\\infty", "∞"],
    ["\\log_{#?}", "log"],
    ["+", "+"],
    ["-", "−"],
    ["\\geq", "≥"],
    ["\\leq", "≤"],
    ["\\pi", "π"],
    ["\\left|#?\\right|", "|x|"],
    ["\\left(#?\\right)", "( )"],
    ["\\times", "×"],
    ["\\div", "÷"],
    ["\\neq", "≠"],
    ["\\rightarrow", "→"],
    ["\\Rightarrow", "⇒"],
  ];

  return buttons
    .map(([cmd, label]) => `
      <button class="math-btn"
              data-command="${cmd}"
              style="width:32px;height:28px;border:1px solid #999;background:#fff;
                     cursor:pointer;font-size:12px;border-radius:3px;">
        ${label}
      </button>
    `)
    .join("");
}

/****************************************************
 * PART 4 — Setup TinyMCE + Click Handler
 ****************************************************/

tinymce.init({
  selector: "#editor",
  height: 500,
  menubar: false,
  plugins: "image code table lists link",
  toolbar:
    "undo redo | bold italic | alignleft aligncenter alignright | bullist numlist | mathBtn | code",

  setup: function (editor) {

    /* Add math button */
    editor.ui.registry.addButton("mathBtn", {
      text: "∑",
      tooltip: "Insert Math Formula",
      onAction: () => {
        const dialog = createMathDialog("");
        editor.windowManager.open(dialog);
        setTimeout(setupMathDialogEvents, 300);
      }
    });

    /* Click existing formula image to edit */
    editor.on("click", (e) => {
      const img = e.target.closest(".math-formula-img");
      if (img) {
        const latex = img.getAttribute("data-imath-latex") || "";
        const dialog = createMathDialog(latex, img);
        editor.windowManager.open(dialog);
        setTimeout(() => setupMathDialogEvents(latex), 300);
      }
    });
  }
});
/****************************************************
 * PART 5 — Math Dialog Events (Toolbar, Preview, Exports)
 ****************************************************/

/** Setup dialog event listeners (toolbar buttons, preview, exports) */
function setupMathDialogEvents(initialLatex = "") {
  const field = document.getElementById("mathlive-editor");
  const preview = document.getElementById("latex-preview");

  if (!field) return;

  /* Initialize with previous LaTeX if editing */
  if (initialLatex) {
    field.setValue(initialLatex);
    preview.textContent = initialLatex;
  }

  /* === LIVE LATEX PREVIEW === */
  function updatePreview() {
    preview.textContent = field.getValue("latex") || "(empty)";
  }
  field.addEventListener("input", updatePreview);


  /* === TOOLBAR BUTTONS === */
  const buttons = document.querySelectorAll(".math-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const cmd = btn.getAttribute("data-command");
      if (!cmd) return;

      field.focus();
      field.insert(cmd);
      setTimeout(updatePreview, 20);
    });
  });


  /* === EXPORT BUTTONS === */
  const exportBtns = document.querySelectorAll(".export-btn");
  exportBtns.forEach(btn => {
    btn.addEventListener("click", async () => {
      const type = btn.getAttribute("data-type");
      const latex = field.getValue("latex");
      if (!latex) return;

      if (type === "mathml") {
        const mathml = latexToMathML(latex);
        copyToClipboard(mathml, "MathML");
      }

      if (type === "svg") {
        try {
          const svg = MathJax.tex2svg(latex);
          const svgString = MathJax.startup.adaptor.outerHTML(svg);
          copyToClipboard(svgString, "SVG XML");
        } catch (e) {
          alert("SVG export failed: " + e.message);
        }
      }

      if (type === "png") {
        const png = await latexToPNG(latex);
        downloadImage(png, "formula.png");
      }
    });
  });


  /* === CLEAR BUTTON === */
  const clearBtn = document.getElementById("math-clear");
  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      field.setValue("");
      updatePreview();
    });
  }
}


/****************************************************
 * PART 6 — Utility Functions (Clipboard, Download)
 ****************************************************/

/** Copy text to clipboard */
function copyToClipboard(text, label) {
  navigator.clipboard.writeText(text)
    .then(() => alert(label + " copied to clipboard!"))
    .catch(() => {
      // fallback: show prompt
      prompt("Copy " + label + ":", text);
    });
}

/** Trigger download of a PNG */
function downloadImage(dataUrl, filename) {
  const a = document.createElement("a");
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

</script>

</body>
</html>



</script>
